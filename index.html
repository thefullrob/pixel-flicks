<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Flicks: Movie Poster Quiz - 1P/2P</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for generating music -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .game-container {
            width: 100%;
            max-width: 700px;
            background-color: #2d3748;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            position: relative; /* Needed for score animation positioning */
        }
        #posterCanvas {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background-color: #000;
        }
        .choice-button {
            transition: background-color 0.15s ease-in-out, transform 0.1s;
        }
        .choice-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }
        .choice-button.correct {
            background-color: #10b981; /* Green 500 */
        }
        .choice-button.incorrect {
            background-color: #ef4444; /* Red 500 */
        }
        .choice-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .timer-bar-bg {
            height: 10px;
            background-color: #4a5568;
            border-radius: 9999px;
            overflow: hidden;
        }
        #timerBar {
            height: 100%;
            background-color: #3b82f6; /* Blue 500 */
            transition: width 1s linear;
        }

        /* Score Animation Keyframes */
        @keyframes score-fly {
            0% {
                opacity: 1;
                transform: scale(1.5) translateY(0);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) translateY(-50px);
            }
        }

        /* Score Animation Element Style */
        .score-popup {
            position: absolute;
            font-size: 2.5rem;
            font-weight: bold;
            color: #34d399; /* Emerald Green */
            animation: score-fly 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 10;
            text-shadow: 0 0 10px rgba(52, 211, 153, 0.7);
        }

        /* Player-specific styles */
        .player-1-color { color: #fcd34d; } /* Amber */
        .player-2-color { color: #60a5fa; } /* Blue */
        .buzzer-ready { box-shadow: 0 0 15px #fcd34d, 0 0 15px #60a5fa; }
    </style>
</head>
<body>

    <div id="game-app" class="game-container p-6 text-white">

        <!-- Header and Music Button -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-extrabold text-yellow-400">
                Pixel Flicks
            </h1>
            <button id="musicButton" 
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-full text-sm transition duration-150"
                    onclick="toggleMusic()">
                <span id="musicIcon">&#128266;</span> Music ON
            </button>
        </div>

        <!-- Mode Selection Screen (Initially Visible) -->
        <div id="modeSelection" class="text-center">
            <h2 class="text-2xl font-bold mb-4 text-white">Choose Your Game Mode</h2>
            <button class="px-6 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-full mb-3 w-full sm:w-2/3" onclick="startGame('1P')">
                1-Player Mode (Standard Scoring)
            </button>
            <button class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-full w-full sm:w-2/3" onclick="startGame('2P')">
                2-Player Mode (Hotseat Buzzer: Q vs P)
            </button>
        </div>
        
        <!-- Game Content (Initially Hidden) -->
        <div id="gameContent" class="hidden">
            
            <!-- Scoreboard and Timer -->
            <div id="scoreboard" class="flex flex-col gap-3 mb-4 p-3 bg-gray-700 rounded-lg">
                
                <!-- 1P Score Display -->
                <div id="scoreDisplay1P" class="flex justify-between items-center hidden">
                    <div class="text-xl font-semibold player-1-color">
                        Score: <span id="totalScore1P">0</span> 
                    </div>
                </div>

                <!-- 2P Score Display -->
                <div id="scoreDisplay2P" class="flex justify-between items-center hidden">
                    <div class="text-xl font-semibold player-1-color">
                        P1 Score: <span id="totalScoreP1">0</span> 
                        <span id="buzzerP1" class="text-xs ml-2 py-0.5 px-1 bg-gray-600 rounded">Q-BUZZER</span>
                    </div>
                    <div class="text-xl font-semibold player-2-color">
                        P2 Score: <span id="totalScoreP2">0</span>
                        <span id="buzzerP2" class="text-xs ml-2 py-0.5 px-1 bg-gray-600 rounded">P-BUZZER</span>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    <div class="text-xl font-semibold">Round: <span id="roundNumber">1</span></div>
                    <div class="text-xl font-semibold">Current Points: <span id="currentPoints">100</span></div>
                </div>
                
            </div>

            <!-- Timer Bar -->
            <div class="mb-4">
                <p class="text-sm text-gray-400 mb-1">Time Remaining: <span id="timeLeftDisplay">15</span>s</p>
                <div class="timer-bar-bg">
                    <div id="timerBar" style="width: 100%;"></div>
                </div>
            </div>
            
            <!-- Poster Canvas Area -->
            <div class="flex justify-center">
                <!-- Canvas is set to a fixed aspect ratio for poster display -->
                <canvas id="posterCanvas" width="300" height="450" class="rounded-lg shadow-xl"></canvas>
            </div>

            <!-- Status Message and Start/Next Button -->
            <div class="text-center my-4">
                <p id="statusMessage" class="text-lg font-medium min-h-[1.5rem]"></p>
                <button id="nextButton" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-full mt-2" onclick="nextRound()">
                    Start Round
                </button>
            </div>

            <!-- Multiple Choice Buttons -->
            <div id="choicesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                <!-- Buttons will be dynamically added here -->
            </div>
        </div>

    </div>

    <!-- 
        NOTE: Since this is running locally inside the chat environment, 
        we must include the data array directly here instead of using the external link 
        like <script src="./movie-data.js"></script>.
    -->
    <script>
        // --- DATA INTEGRATION (Temporary for local preview) ---
        // This is the content of your movie-data.js file:
        const movieData = [
            // Using placeholder links that should fail, proving the local link system works when you upload 1.jpg
            { id: 1, title: "Jaws", year: 1975, correct: "A", image: "./images/1.jpg", options: ["Jaws", "The Poseidon Adventure", "Deep Blue Sea", "Close Encounters"] },
            { id: 2, title: "E.T. the Extra-Terrestrial", year: 1982, correct: "B", image: "./images/2.jpg", options: ["Gremlins", "E.T. the Extra-Terrestrial", "Flight of the Navigator", "Alien"] },
            { id: 3, title: "Back to the Future", year: 1985, correct: "C", image: "./images/3.jpg", options: ["Ferris Bueller's Day Off", "The Goonies", "Back to the Future", "Short Circuit"] },
            { id: 4, title: "Pulp Fiction", year: 1994, correct: "A", image: "./images/4.jpg", options: ["Pulp Fiction", "Reservoir Dogs", "Snatch", "The Big Lebowski"] },
            { id: 5, title: "The Matrix", year: 1999, correct: "D", image: "./images/5.jpg", options: ["Terminator 2", "Inception", "Dark City", "The Matrix"] },
            { id: 6, title: "The Fellowship of the Ring", year: 2001, correct: "B", image: "./images/6.jpg", options: ["Harry Potter", "The Fellowship of the Ring", "Narnia", "Eragon"] },
            { id: 7, title: "The Dark Knight", year: 2008, correct: "C", image: "./images/7.jpg", options: ["Batman Begins", "Man of Steel", "The Dark Knight", "Watchmen"] },
            { id: 8, title: "Inception", year: 2010, correct: "A", image: "./images/8.jpg", options: ["Inception", "Tenet", "Interstellar", "Shutter Island"] },
            { id: 9, title: "Inside Out", year: 2015, correct: "D", image: "./images/9.jpg", options: ["Coco", "Up", "Soul", "Inside Out"] },
            { id: 10, title: "Dune", year: 2021, correct: "B", image: "./images/10.jpg", options: ["Blade Runner 2049", "Dune", "Arrival", "Interstellar"] },
            { id: 11, title: "The Shining", year: 1980, correct: "C", image: "./images/11.jpg", options: ["Psycho", "Carrie", "The Shining", "Exorcist"] },
            { id: 12, title: "The Shawshank Redemption", year: 1994, correct: "A", image: "./images/12.jpg", options: ["The Shawshank Redemption", "Forrest Gump", "Pulp Fiction", "Green Mile"] },
            { id: 13, title: "Finding Nemo", year: 2003, correct: "B", image: "./images/13.jpg", options: ["Toy Story 3", "Finding Nemo", "Shrek", "Monsters Inc"] },
            { id: 14, title: "The Godfather Part II", year: 1974, correct: "D", image: "./images/14.jpg", options: ["Goodfellas", "The Untouchables", "Scarface", "The Godfather Part II"] },
            { id: 15, title: "Interstellar", year: 2014, correct: "B", image: "./images/15.jpg", options: ["Gravity", "Interstellar", "Arrival", "The Martian"] },
            { id: 16, title: "Die Hard", year: 1988, correct: "A", image: "./images/16.jpg", options: ["Die Hard", "Lethal Weapon", "Terminator", "Total Recall"] },
            { id: 17, title: "Top Gun: Maverick", year: 2022, correct: "D", image: "./images/17.jpg", options: ["Dune Part Two", "No Time to Die", "Oppenheimer", "Top Gun: Maverick"] },
            { id: 18, title: "The Silence of the Lambs", year: 1991, correct: "C", image: "./images/18.jpg", options: ["Se7en", "Fargo", "The Silence of the Lambs", "Usual Suspects"] },
            { id: 19, title: "Avatar", year: 2009, correct: "A", image: "./images/19.jpg", options: ["Avatar", "District 9", "Star Trek", "Prometheus"] },
            { id: 20, title: "Alien", year: 1979, correct: "B", image: "./images/20.jpg", options: ["The Thing", "Alien", "Close Encounters", "Star Wars"] },
            { id: 21, title: "Raiders of the Lost Ark", year: 1981, correct: "D", image: "./images/21.jpg", options: ["The Mummy", "Romancing the Stone", "Indiana Jones", "Raiders of the Lost Ark"] },
            { id: 22, title: "1917", year: 2019, correct: "C", image: "./images/22.jpg", options: ["Dunkirk", "Saving Private Ryan", "1917", "Hacksaw Ridge"] },
            { id: 23, title: "Jurassic Park", year: 1993, correct: "A", image: "./images/23.jpg", options: ["Jurassic Park", "Twister", "Godzilla", "Armageddon"] },
            { id: 24, "title": "Oppenheimer", year: 2023, correct: "B", image: "./images/24.jpg", options: ["Tenet", "Oppenheimer", "The Martian", "Dunkirk"] },
            { id: 25, title: "Ghostbusters", year: 1984, correct: "D", image: "./images/25.jpg", options: ["Beetlejuice", "Gremlins", "E.T.", "Ghostbusters"] }
        ];

        // --- Tone.js (Audio) Setup ---
        let musicActive = false;
        let isMuted = false;
        let synth = null;
        let loop = null;
        const musicButtonEl = document.getElementById('musicButton');
        const musicIconEl = document.getElementById('musicIcon');

        // Sound effects synths
        let winSynth = null;
        let loseSynth = null;

        function setupMusic() {
            if (synth || !window.Tone) return;

            // Background Music Synth
            synth = new Tone.FMSynth().toDestination();
            synth.volume.value = -12; // Keep volume moderate

            // Win Sound Synth (Simple triangle wave for a chime)
            winSynth = new Tone.Synth({ 
                oscillator: { type: "triangle" },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.5 }
            }).toDestination();
            winSynth.volume.value = -8;

            // Lose Sound Synth (Low bass for a fail noise)
            loseSynth = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.1, decay: 0.5, sustain: 0, release: 0.5 }
            }).toDestination();
            loseSynth.volume.value = -6;


            // Define a simple looping progression (notes: C4, C3, F3, F2)
            const notes = ["C3", "C2", "F2", "F1"]; 
            let index = 0;

            loop = new Tone.Loop(time => {
                const note = notes[index % notes.length];
                synth.triggerAttackRelease(note, "4n", time);
                index++;
            }, "1m").start(0);

            Tone.Transport.bpm.value = 60;
            Tone.Transport.loop = true;
            Tone.Transport.loopEnd = '4m';
        }
        
        // Play sound based on result
        function playSound(isCorrect) {
            if (isMuted) return;
            
            if (isCorrect) {
                // Play a happy rising chord (C5, E5, G5)
                winSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n");
            } else {
                // Play a disappointing low chord (C2, G1)
                loseSynth.triggerAttackRelease(["C2", "G1"], "4n");
            }
        }


        async function toggleMusic() {
            // First time a user clicks, we start the audio context
            if (Tone.context.state !== 'running') {
                await Tone.start();
                setupMusic();
                
            }

            isMuted = !isMuted;
            if (isMuted) {
                Tone.Transport.stop();
                musicIconEl.innerHTML = '&#128263;'; // Mute icon
                musicButtonEl.textContent = ' Music OFF';
                musicButtonEl.prepend(musicIconEl);
            } else {
                Tone.Transport.start();
                musicIconEl.innerHTML = '&#128266;'; // Speaker icon
                musicButtonEl.textContent = ' Music ON';
                musicButtonEl.prepend(musicIconEl);
            }
        }

        // --- Configuration ---
        const TIMER_MAX = 15; // Seconds per round
        const REVEAL_LIMIT = 0.70; // Stop revealing at 70% completion
        const MAX_SCORE = 100;

        // --- Game State Variables ---
        let gameState = {
            mode: '1P', // NEW: '1P' or '2P'
            totalScore1P: 0, // NEW: Single Player Score
            totalScoreP1: 0, // Player 1 score (2P)
            totalScoreP2: 0, // Player 2 score (2P)
            buzzerLockedBy: null, // Stores 'P1' or 'P2' if someone buzzed
            round: 0,
            currentMovie: null,
            timerInterval: null,
            timeLeft: TIMER_MAX,
            isGameOver: true,
            posterImage: new Image(),
            pixelatedChunks: []
        };
        
        // --- DOM References ---
        const modeSelectionEl = document.getElementById('modeSelection');
        const gameContentEl = document.getElementById('gameContent');
        const scoreDisplay1PEl = document.getElementById('scoreDisplay1P');
        const scoreDisplay2PEl = document.getElementById('scoreDisplay2P');
        
        const totalScore1PEl = document.getElementById('totalScore1P'); // NEW
        const totalScoreP1El = document.getElementById('totalScoreP1'); 
        const totalScoreP2El = document.getElementById('totalScoreP2'); 
        const buzzerP1El = document.getElementById('buzzerP1'); 
        const buzzerP2El = document.getElementById('buzzerP2'); 
        
        const roundNumberEl = document.getElementById('roundNumber');
        const currentPointsEl = document.getElementById('currentPoints');
        const timeLeftDisplayEl = document.getElementById('timeLeftDisplay');
        const timerBarEl = document.getElementById('timerBar');
        const statusMessageEl = document.getElementById('statusMessage');
        const nextButtonEl = document.getElementById('nextButton');
        const choicesContainerEl = document.getElementById('choicesContainer');
        const canvas = document.getElementById('posterCanvas');
        const ctx = canvas.getContext('2d');
        const CANVAS_W = canvas.width;
        const CANVAS_H = canvas.height;
        const CHUNK_SIZE = 15; // Size of the square chunks for reveal effect

        // --- Keyboard Controls (2P Only) ---
        document.addEventListener('keydown', (e) => {
            if (gameState.mode !== '2P' || gameState.isGameOver || gameState.buzzerLockedBy) return;

            // Player 1 Buzzer: 'Q'
            if (e.key.toLowerCase() === 'q') {
                buzzIn('P1');
            } 
            // Player 2 Buzzer: 'P'
            else if (e.key.toLowerCase() === 'p') {
                buzzIn('P2');
            }
        });

        function buzzIn(player) {
            if (gameState.isGameOver || gameState.buzzerLockedBy) return;

            gameState.buzzerLockedBy = player;
            clearInterval(gameState.timerInterval); // Stop the timer immediately
            
            // Visual feedback
            const buzzerEl = player === 'P1' ? buzzerP1El : buzzerP2El;
            buzzerEl.textContent = `${player} GUESSING...`;
            buzzerEl.classList.remove('bg-gray-600');
            buzzerEl.classList.add('bg-yellow-600', 'animate-pulse');

            statusMessageEl.textContent = `${player} buzzed in! Select your answer now.`;
            statusMessageEl.classList.remove('text-red-400', 'text-green-400');
            statusMessageEl.classList.add(player === 'P1' ? 'player-1-color' : 'player-2-color');
        }

        function resetBuzzer() {
            gameState.buzzerLockedBy = null;
            if (gameState.mode === '2P') {
                buzzerP1El.textContent = 'Q-BUZZER';
                buzzerP2El.textContent = 'P-BUZZER';
                buzzerP1El.classList.remove('bg-yellow-600', 'animate-pulse');
                buzzerP2El.classList.remove('bg-yellow-600', 'animate-pulse');
                buzzerP1El.classList.add('bg-gray-600');
                buzzerP2El.classList.add('bg-gray-600');
            }
        }

        // --- Initialization and Mode Selection ---

        window.onload = () => {
            // Setup music synths, but leave muted
            setupMusic();
            Tone.Transport.stop(); 
            isMuted = true;
            musicIconEl.innerHTML = '&#128263;'; 
            musicButtonEl.textContent = ' Music OFF';
            musicButtonEl.prepend(musicIconEl);
            
            // Show mode selection screen
            modeSelectionEl.classList.remove('hidden');
            gameContentEl.classList.add('hidden');

            // Draw initial placeholder
            if (movieData.length > 0) {
                 drawPoster(movieData[0].image, true);
            } else {
                 drawPoster("https://placehold.co/300x450/222222/cccccc?text=Loading+Data...", true);
            }
        };

        function startGame(mode) {
            gameState.mode = mode;
            
            // Hide selection, show game content
            modeSelectionEl.classList.add('hidden');
            gameContentEl.classList.remove('hidden');

            // Set up the correct scoreboard display
            scoreDisplay1PEl.classList.add('hidden');
            scoreDisplay2PEl.classList.add('hidden');
            
            if (mode === '1P') {
                scoreDisplay1PEl.classList.remove('hidden');
                statusMessageEl.textContent = 'Click START ROUND to begin!';
            } else {
                scoreDisplay2PEl.classList.remove('hidden');
                statusMessageEl.textContent = 'Players ready! P1: Q, P2: P to buzz in.';
            }
        }
        
        /**
         * Calculates the score based on remaining time.
         */
        function calculateScore() {
            if (gameState.timeLeft <= 0) return 0;
            const score = Math.round((gameState.timeLeft / TIMER_MAX) * MAX_SCORE);
            return score;
        }

        /**
         * Shuffles an array (Fisher-Yates algorithm).
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // --- Canvas and Reveal Logic ---

        /**
         * Draws the poster image onto the canvas and initializes the pixelation grid.
         */
        function drawPoster(url, pixelate = false) {
            ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);

            gameState.posterImage.onload = () => {
                ctx.drawImage(gameState.posterImage, 0, 0, CANVAS_W, CANVAS_H);

                if (pixelate) {
                    gameState.pixelatedChunks = [];
                    for (let x = 0; x < CANVAS_W; x += CHUNK_SIZE) {
                        for (let y = 0; y < CANVAS_H; y += CHUNK_SIZE) {
                            // Store coordinates for each chunk to be revealed
                            gameState.pixelatedChunks.push({ x: x, y: y, revealed: false });
                            // Draw the initial cover (black square)
                            ctx.fillStyle = '#222222'; 
                            ctx.fillRect(x, y, CHUNK_SIZE, CHUNK_SIZE);
                        }
                    }
                    // Shuffle the chunks so they reveal randomly
                    shuffleArray(gameState.pixelatedChunks);
                }
            };
            gameState.posterImage.onerror = () => {
                // Fallback for image loading error - Shows a red box with error text
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);
                ctx.fillStyle = '#fff';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('ERROR LOADING IMAGE', CANVAS_W / 2, CANVAS_H / 2 - 10);
                ctx.fillText(`Check round ${gameState.round}.jpg in /images folder`, CANVAS_W / 2, CANVAS_H / 2 + 10);
            };
            // Set cross-origin to anonymous for canvas image usage 
            gameState.posterImage.crossOrigin = "anonymous"; 
            gameState.posterImage.src = url;
        }
        
        /**
         * Reveals one piece of the poster by clearing the cover chunk.
         */
        function revealPosterPiece() {
            // Calculate how many pieces should be revealed based on time remaining
            const timeElapsedRatio = (TIMER_MAX - gameState.timeLeft) / TIMER_MAX;
            
            if (timeElapsedRatio >= REVEAL_LIMIT) return;

            const totalChunks = gameState.pixelatedChunks.length;
            const targetIndex = Math.floor(totalChunks * timeElapsedRatio);

            for (let i = 0; i < targetIndex; i++) {
                const chunk = gameState.pixelatedChunks[i];
                if (!chunk.revealed) {
                    const sx = chunk.x; 
                    const sy = chunk.y; 
                    const sw = CHUNK_SIZE; 
                    const sh = CHUNK_SIZE; 
                    const dx = chunk.x; 
                    const dy = chunk.y; 
                    const dw = CHUNK_SIZE; 
                    const dh = CHUNK_SIZE; 

                    ctx.drawImage(gameState.posterImage, sx, sy, sw, sh, dx, dy, dw, dh);
                    chunk.revealed = true;
                }
            }
        }
        
        /**
         * Fully reveals the poster (used when time runs out or guess is made).
         */
        function fullReveal() {
            ctx.drawImage(gameState.posterImage, 0, 0, CANVAS_W, CANVAS_H);
            gameState.pixelatedChunks.forEach(chunk => chunk.revealed = true);
        }

        // --- Game Flow Functions ---

        function startTimer() {
            gameState.timeLeft = TIMER_MAX;
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft -= 1;
                
                const currentScore = calculateScore();
                currentPointsEl.textContent = currentScore;
                timeLeftDisplayEl.textContent = gameState.timeLeft;
                timerBarEl.style.width = `${(gameState.timeLeft / TIMER_MAX) * 100}%`;
                
                revealPosterPiece();

                if (gameState.timeLeft <= 0) {
                    endRound(false); // Time ran out
                }
            }, 1000);
        }

        function nextRound() {
            if (typeof movieData === 'undefined' || movieData.length === 0) {
                statusMessageEl.textContent = "Error: Movie data failed to load. Please check movie-data.js file.";
                nextButtonEl.textContent = 'Data Error';
                nextButtonEl.classList.remove('hidden');
                return;
            }

            if (gameState.round >= movieData.length) {
                // Game over
                let finalScoreMessage;
                if (gameState.mode === '1P') {
                    finalScoreMessage = `GAME OVER! Your Final Score: ${gameState.totalScore1P}.`;
                } else {
                    let winnerText = "It's a TIE!";
                    if (gameState.totalScoreP1 > gameState.totalScoreP2) {
                        winnerText = "Player 1 WINS!";
                    } else if (gameState.totalScoreP2 > gameState.totalScoreP1) {
                        winnerText = "Player 2 WINS!";
                    }
                    finalScoreMessage = `GAME OVER! Final Score - P1: ${gameState.totalScoreP1}, P2: ${gameState.totalScoreP2}. ${winnerText}`;
                }
                
                statusMessageEl.textContent = finalScoreMessage;
                nextButtonEl.textContent = 'Play Again';
                
                // Reset Scores
                gameState.round = 0;
                gameState.totalScore1P = 0;
                gameState.totalScoreP1 = 0;
                gameState.totalScoreP2 = 0;
                return;
            }
            
            gameState.isGameOver = false;
            gameState.round++;
            gameState.currentMovie = movieData[gameState.round - 1];

            // Reset UI and Buzzer State
            resetBuzzer();
            clearInterval(gameState.timerInterval);
            currentPointsEl.textContent = MAX_SCORE;
            roundNumberEl.textContent = gameState.round;
            
            let roundStartMessage;
            if (gameState.mode === '1P') {
                roundStartMessage = `Round ${gameState.round} of ${movieData.length}. Guess the movie!`;
            } else {
                roundStartMessage = `Round ${gameState.round} of ${movieData.length}. Buzz in (Q or P) to guess!`;
            }
            statusMessageEl.textContent = roundStartMessage;
            statusMessageEl.classList.remove('text-red-400', 'text-green-400', 'player-1-color', 'player-2-color');
            nextButtonEl.classList.add('hidden');
            
            drawPoster(gameState.currentMovie.image, true);
            renderChoices(gameState.currentMovie.options);
            
            startTimer();
        }

        function renderChoices(choices) {
            choicesContainerEl.innerHTML = '';
            const optionsMap = ['A', 'B', 'C', 'D'];
            
            choices.forEach((title, index) => {
                const optionChar = optionsMap[index];
                const button = document.createElement('button');
                button.className = 'choice-button px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg text-left';
                button.setAttribute('data-choice', optionChar);
                
                // Click handler changes based on mode
                if (gameState.mode === '1P') {
                    button.onclick = (e) => checkAnswer(optionChar, e.currentTarget, '1P');
                } else {
                    button.onclick = (e) => checkAnswer(optionChar, e.currentTarget, gameState.buzzerLockedBy);
                }
                
                button.textContent = `${optionChar}) ${title} (${gameState.currentMovie.year})`;
                choicesContainerEl.appendChild(button);
            });
        }

        function checkAnswer(chosenOption, button, guessingPlayer) {
            clearInterval(gameState.timerInterval); // Pause timer
            
            // Enforcement based on mode
            if (gameState.mode === '2P' && !guessingPlayer) {
                statusMessageEl.textContent = "Error: Buzz in (Q or P) first!";
                statusMessageEl.classList.add('text-red-400');
                startTimer(); // Restart timer after error message
                return;
            }

            if (gameState.isGameOver) return; 
            
            const isCorrect = chosenOption === gameState.currentMovie.correct;
            endRound(isCorrect, button, guessingPlayer);
        }

        /**
         * Ends the current round, updates score, and shows the result.
         */
        function endRound(isCorrect, clickedButton = null, scoringTarget = '1P') {
            gameState.isGameOver = true;
            
            // Play sound feedback
            playSound(isCorrect);
            
            // Full poster reveal
            fullReveal();

            let roundPoints = 0;
            let statusPlayer = (scoringTarget === 'P1' || scoringTarget === 'P2') ? scoringTarget : 'You';
            
            if (isCorrect) {
                roundPoints = calculateScore();
                
                // Assign score based on mode/player
                if (scoringTarget === '1P') {
                    gameState.totalScore1P += roundPoints;
                    totalScore1PEl.textContent = gameState.totalScore1P;
                } else if (scoringTarget === 'P1') {
                    gameState.totalScoreP1 += roundPoints;
                    totalScoreP1El.textContent = gameState.totalScoreP1;
                } else if (scoringTarget === 'P2') {
                    gameState.totalScoreP2 += roundPoints;
                    totalScoreP2El.textContent = gameState.totalScoreP2;
                }
                
                // ANMATION: Trigger score celebration on correct guess
                if (roundPoints > 0) {
                    animateScorePopup(roundPoints, scoringTarget);
                }
                
                statusMessageEl.textContent = `${statusPlayer} is CORRECT! Earned ${roundPoints} points!`;
                statusMessageEl.classList.remove('text-red-400');
                statusMessageEl.classList.add('text-green-400');
            } else {
                // Incorrect guess or time up
                if (scoringTarget === 'P1' || scoringTarget === 'P2') {
                    // 2P penalty only applies if a player buzzed in (not if time ran out)
                    if (gameState.buzzerLockedBy) { 
                        const penalty = 10;
                        if (scoringTarget === 'P1') gameState.totalScoreP1 = Math.max(0, gameState.totalScoreP1 - penalty);
                        if (scoringTarget === 'P2') gameState.totalScoreP2 = Math.max(0, gameState.totalScoreP2 - penalty);
                        totalScoreP1El.textContent = gameState.totalScoreP1;
                        totalScoreP2El.textContent = gameState.totalScoreP2;
                        statusMessageEl.textContent = `${statusPlayer} is INCORRECT! (-${penalty} pts). The answer was "${gameState.currentMovie.title}".`;
                    } else {
                         statusMessageEl.textContent = `TIME UP! The answer was "${gameState.currentMovie.title}".`;
                    }
                } else {
                    // 1P or time up message
                    statusMessageEl.textContent = `TIME UP / INCORRECT! The answer was "${gameState.currentMovie.title}".`;
                }
                statusMessageEl.classList.add('text-red-400');
                statusMessageEl.classList.remove('text-green-400');
            }
            
            // Update current points display
            currentPointsEl.textContent = roundPoints;

            // Highlight buttons
            Array.from(choicesContainerEl.children).forEach(btn => {
                btn.disabled = true;
                const choice = btn.getAttribute('data-choice');
                if (choice === gameState.currentMovie.correct) {
                    btn.classList.add('correct');
                    btn.classList.remove('bg-blue-600');
                } else if (btn === clickedButton) {
                    btn.classList.add('incorrect');
                    btn.classList.remove('bg-blue-600');
                }
            });

            nextButtonEl.classList.remove('hidden');
            nextButtonEl.textContent = (gameState.round < movieData.length) ? 'Next Poster' : 'Finish Game';
        }

        /**
         * ANIMATION FUNCTION: Creates and animates a score popup.
         */
        function animateScorePopup(points, target) {
            const popup = document.createElement('span');
            popup.textContent = `+${points}`;
            popup.classList.add('score-popup');
            
            const gameApp = document.getElementById('game-app');
            gameApp.appendChild(popup);

            let targetEl;
            if (target === '1P') {
                targetEl = totalScore1PEl;
                popup.style.color = '#fcd34d'; 
            } else if (target === 'P1') {
                targetEl = totalScoreP1El;
                popup.style.color = '#fcd34d'; // Player 1 color
            } else { // P2
                targetEl = totalScoreP2El;
                popup.style.color = '#60a5fa'; // Player 2 color
            }

            // Measure the target element's position relative to the game container
            const targetRect = targetEl.getBoundingClientRect();
            const gameRect = gameApp.getBoundingClientRect();
            
            // Calculate starting position near the target score display
            popup.style.top = `${targetRect.top - gameRect.top}px`;
            popup.style.left = `${targetRect.left - gameRect.left}px`;

            // Clean up the element after the animation finishes
            popup.addEventListener('animationend', () => {
                popup.remove();
            });
        }

    </script>
</body>
</html>
